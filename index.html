<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, user-scalable=0">
    <title>Test</title>

    <script src="static/jquery.min.js"></script>
    <style>
        html,
        body
        {
            width: 100%;
            height: 100%;
            padding: 10px;
            margin: 0;
            /*overflow: hidden;*/
            box-sizing: border-box;
            text-align: center;
        }
        button
        {
            font-size: 18px;
            padding: 8px;
            margin: 20px;
        }
        canvas
        {
            border: 1px solid black;
        }
    </style>
</head>
<body>
<canvas width="280" height="280" id="canvas"></canvas>
<h1>识别结果：<span id="digit">无</span></h1>
<br>
<button id="clear">清除</button>
<button id="recognize">识别</button>

<script>
    const point = {}
    const canvas = document.getElementById('canvas')
    const ctx = canvas.getContext('2d')
    const setContext = function()
    {
        ctx.lineWidth = 20
        ctx.strokeStyle = 'black'
        ctx.lineCap = 'round'
        ctx.lineJoin = 'round'
        ctx.shadowBlur = 1
        ctx.shadowColor = 'grey'
    }
    const left = canvas.getBoundingClientRect().left
    const up = canvas.getBoundingClientRect().top

    const isMobile = /(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i.test(navigator.userAgent);

    const paint = function(signal)
    {
        switch(signal)
        {
            case 'start':
            {
                ctx.beginPath()
                ctx.moveTo(point.x, point.y)
                ctx.lineTo(point.x, point.y)
                ctx.stroke()
                break
            }
            case 'move':
            {
                ctx.lineTo(point.x, point.y)
                ctx.stroke()
                break
            }
        }
    }

    let pressed = false
    const start = function(e)
    {
        e.preventDefault()
        pressed = true
        e = isMobile ? e.touches[0] : e
        point.x = e.clientX - left + 0.5
        point.y = e.clientY - up + 0.5
        paint('start')
    }
    const move = function(e)
    {
        e.preventDefault()
        if (!pressed)
        {
            return
        }
        requestAnimationFrame(function()
        {
            e = isMobile ? e.touches[0] : e
            point.x = e.clientX - left + 0.5
            point.y = e.clientY - up + 0.5
            paint('move')
        })
    }

    if (isMobile)
    {
        canvas.addEventListener('touchstart', start)
        canvas.addEventListener('touchmove', move)
    }
    else
    {
        canvas.addEventListener('mousedown', start)
        canvas.addEventListener('mousemove', move)
        ;['mouseup', 'mouseleave'].forEach(function(e)
        {
            canvas.addEventListener(e, function()
            {
                pressed = false
            })
        })
    }

    const forRetina = function()
    {
        let { width, height } = window.getComputedStyle(canvas, null)
        width = width.replace('px', '')
        height = height.replace('px', '')
        const devicePixelRatio = window.devicePixelRatio;
        if (devicePixelRatio)
        {
            canvas.style.width = `${width}px`;
            canvas.style.height = `${height}px`;
            canvas.height = height * devicePixelRatio; // 画布宽高放大
            canvas.width = width * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio); // 画布内容放大相同的倍数
        }
        else
        {
            canvas.width = width;
            canvas.height = height;
        }
    }
    forRetina()
    setContext()

    function canvasToArray()
    {
        const imageData = ctx.getImageData(0, 0, 280, 280).data
        const pixelArray = []
        for (let x = 0; x < 280; x ++)
        {
            for (let y = 0; y < 280; y ++)
            {
                const index = x * 280 * 4 + y * 4
                if (imageData[index] + imageData[index + 1] + imageData[index + 2] + imageData[index + 3] > 0)
                {
                    pixelArray.push(1)
                }
                else
                {
                    pixelArray.push(0)
                }
            }
        }
        // console.log(pixelArray)

        const pixelMatrix = []
        for (let x = 0; x < 280; x ++)
        {
            const row = []
            for (let y = 0; y < 280; y ++)
            {
                const index = x * 280 + y
                row.push(pixelArray[index])
            }
            pixelMatrix.push(row)
        }
        // console.log(pixelMatrix)

        const result = []
        for (let x = 0; x < 28; x ++)
        {
            for (let y = 0; y < 28; y ++)
            {
                let pixelCount = 0
                for (let x1 = 0; x1 < 10; x1 ++)
                {
                    for (let y1 = 0; y1 < 10; y1 ++)
                    {
                        const row = x * 10 + x1
                        const col = y * 10 + y1
                        if (pixelMatrix[row][col] === 1)
                        {
                            // console.log(row, col)
                            pixelCount ++
                        }
                    }
                }
                if (pixelCount > 0)
                {
                    // console.log(x, y, pixelCount / 100)
                    result.push([x, y, pixelCount / 100])
                }
            }
        }
        console.log(result)
    }
    const recognize = function()
    {
        canvasToArray()
        console.log('sending data to server to recognize the digit...')
        const url = 'http://localhost:5000'
        const data = {array: [[1,2,3,4], [1,2,3,4], [1,2,3,4], [1,2,3,4]]}
        const success = function(text)
        {
            console.log(text)
            $("#digit").text(text)
        }
        // $.post(url, JSON.stringify(data), success)
    }
    const clear = function()
    {
        console.log('clear the canvas...done')
        ctx.clearRect(0, 0, canvas.width, canvas.height)
    }
    $("#clear").click(clear)
    $("#recognize").click(recognize)
</script>
</body>
</html>